@namespace BlazorMdc.Demo

<BMdc.Dialog Title=@dialogHeader
           EscapeKeyAction=""
           ScrimClickAction=""
           @ref="pinLogonDialogReference">

    <Body>
        @if (dialogStyle == ePINDialogStyle.CreatePIN)
        {
            <h6>Your PIN has never been set.</h6>
            <h6>Pick a PIN, enter it, and verify the entry.</h6>
            <BMdcPlus.Divider Padded="true" />
        }

        <EditForm Model="@pinLogonDTO" OnValidSubmit="@SubmitLogon">
            <DataAnnotationsValidator />

            @if (dialogStyle == ePINDialogStyle.CreatePIN)
            {
                <div class="form-group">
                    <BMdc.TextField @bind-Value="pinLogonDTO.PIN1"
                                  @onfocus="@(() => FocusPIN("PIN1"))"
                                  Label="New PIN"
                                  TrailingIcon="lock_outline"
                                  type="password" />
                    <ValidationMessage For=@( () => pinLogonDTO.PIN1 ) />
                </div>
                <div class="form-group">
                    <BMdc.TextField @bind-Value="pinLogonDTO.PIN2"
                                  @onfocus="@(() => FocusPIN("PIN2"))"
                                  Label="Verify PIN"
                                  TrailingIcon="lock_outline"
                                  type="password" />
                    <ValidationMessage For=@( () => pinLogonDTO.PIN2 ) />
                </div>
            }
            else
            {
                <div class="form-group">
                    <BMdc.TextField @bind-Value="pinLogonDTO.PIN1"
                                  @onfocus="@(() => FocusPIN("PIN1"))"
                                  Label="PIN"
                                  TrailingIcon="lock_outline"
                                  type="password" />
                    <ValidationMessage For=@( () => pinLogonDTO.PIN1 ) />
                </div>
            }
            <div class="form-group">
                <div style="display: flex; flex-direction:column; justify-content:flex-start;">
                    <div style="display:flex; flex-direction: row; justify-content: center;">
                        <BMdc.Button Label="7"
                                   Style="margin: 0.75em 0.25em 0.25em 0.25em; height: 2rem; width: 2rem;"
                                   @onclick="@(() => NumberClick("7"))"
                                   ButtonStyle="BMdcModel.ButtonStyle.ContainedRaised" />
                        <BMdc.Button Label="8"
                                   Style="margin: 0.75em 0.25em 0.25em 0.25em; height: 2rem; width: 2rem;"
                                   @onclick="@(() => NumberClick("8"))"
                                   ButtonStyle="BMdcModel.ButtonStyle.ContainedRaised" />
                        <BMdc.Button Label="9"
                                   Style="margin: 0.75em 0.25em 0.25em 0.25em; height: 2rem; width: 2rem;"
                                   @onclick="@(() => NumberClick("9"))"
                                   ButtonStyle="BMdcModel.ButtonStyle.ContainedRaised" />
                    </div>
                    <div style="display:flex; flex-direction: row; justify-content: center;">
                        <BMdc.Button Label="4"
                                   Style="margin: 0.75em 0.25em 0.25em 0.25em; height: 2rem; width: 2rem;"
                                   @onclick="@(() => NumberClick("4"))"
                                   ButtonStyle="BMdcModel.ButtonStyle.ContainedRaised" />
                        <BMdc.Button Label="5"
                                   Style="margin: 0.75em 0.25em 0.25em 0.25em; height: 2rem; width: 2rem;"
                                   @onclick="@(() => NumberClick("5"))"
                                   ButtonStyle="BMdcModel.ButtonStyle.ContainedRaised" />
                        <BMdc.Button Label="6"
                                   Style="margin: 0.75em 0.25em 0.25em 0.25em; height: 2rem; width: 2rem;"
                                   @onclick="@(() => NumberClick("6"))"
                                   ButtonStyle="BMdcModel.ButtonStyle.ContainedRaised" />
                    </div>
                    <div style="display:flex; flex-direction: row; justify-content: center;">
                        <BMdc.Button Label="1"
                                   Style="margin: 0.75em 0.25em 0.25em 0.25em; height: 2rem; width: 2rem;"
                                   @onclick="@(() => NumberClick("1"))"
                                   ButtonStyle="BMdcModel.ButtonStyle.ContainedRaised" />
                        <BMdc.Button Label="2"
                                   Style="margin: 0.75em 0.25em 0.25em 0.25em; height: 2rem; width: 2rem;"
                                   @onclick="@(() => NumberClick("2"))"
                                   ButtonStyle="BMdcModel.ButtonStyle.ContainedRaised" />
                        <BMdc.Button Label="3"
                                   Style="margin: 0.75em 0.25em 0.25em 0.25em; height: 2rem; width: 2rem;"
                                   @onclick="@(() => NumberClick("3"))"
                                   ButtonStyle="BMdcModel.ButtonStyle.ContainedRaised" />
                    </div>
                    <div style="display:flex; flex-direction: row; justify-content: center;">
                        <BMdc.Button Label="0"
                                   Style="margin: 0.75em 0.75em 0.25em 0.25em; height: 2rem; width: 2rem;"
                                   @onclick="@(() => NumberClick("0"))"
                                   ButtonStyle="BMdcModel.ButtonStyle.ContainedRaised" />
                        <BMdc.Button Label="Backspace"
                                   Style="margin: 0.75em 0.25em 0.25em 0.25em; height: 2rem; min-width: 128px;"
                                   @onclick="@(() => NumberClick("BKS"))"
                                   ButtonStyle="BMdcModel.ButtonStyle.ContainedRaised" />
                    </div>

                    <div style="display:flex; flex-direction: row; justify-content: center;">
                        @if (dialogStyle == ePINDialogStyle.CreatePIN)
                        {
                            <BMdc.Button Style="margin: 0.75em 0.25em 0.25em 0.25em;"
                                       type="submit"
                                       Label="Create PIN"
                                       ButtonStyle="BMdcModel.ButtonStyle.ContainedRaised" />
                        }
                        else
                        {
                            <BMdc.Button Style="margin: 0.75em 0.25em 0.25em 0.25em;"
                                       type="submit"
                                       Label="Enter PIN"
                                       ButtonStyle="BMdcModel.ButtonStyle.ContainedRaised"/>
                        }
                        <BMdc.Button @onclick="@CancelClick"
                                   Style="margin: 0.75em 0.25em 0.25em 0.25em;"
                                   Label="Cancel"
                                   ButtonStyle="BMdcModel.ButtonStyle.ContainedRaised" />
                    </div>
                </div>
            </div>
            <hr />
        </EditForm>
    </Body>
    <Buttons></Buttons>
</BMdc.Dialog>

@code{

    public enum ePINDialogStyle { CreatePIN, EnterPIN };

    [Inject] private BMdcPlus.IToastService toastService { get; set; }

    [Parameter] public ePINDialogStyle dialogStyle { get; set; }
    [Parameter] public string validationPIN { get; set; }

    private string dialogHeader { get; set; }
    private string lastFocus { get; set; }
    private string returnValue { get; set; }
    private BMdc.Dialog pinLogonDialogReference { get; set; }
    private PINLogonDTO pinLogonDTO = new PINLogonDTO();

    public async Task<string> OpenPINLogonDialogAsync()
    {
        pinLogonDTO.PIN1 = "";
        pinLogonDTO.PIN2 = "";

        if (dialogStyle == ePINDialogStyle.CreatePIN)
        {
            dialogHeader = "Create PIN";
        }
        else
        {
            dialogHeader = "Enter PIN";

            // Prevent validation error
            pinLogonDTO.PIN2 = "x";
        }

        var ret = await pinLogonDialogReference.ShowAsync();
        if (ret.Equals("dismissed"))
        {
            ret = returnValue;
        }

        return ret;
    }

    async Task SubmitLogon()
    {
        if (dialogStyle == ePINDialogStyle.EnterPIN)
        {
            if (pinLogonDTO.PIN1 == validationPIN)
            {
                returnValue = "<Log on succeeded>";

                toastService.ShowToast(
                    level: BMdcModel.ToastLevel.Success,
                    message: "Log on succeeded");

                await pinLogonDialogReference.HideAsync();
            }
            else
            {
                toastService.ShowToast(
                    level: BMdcModel.ToastLevel.Error,
                    message: "Log on failed");
            }
        }
        else
        {
            if (pinLogonDTO.PIN1 == pinLogonDTO.PIN2)
            {
                returnValue = "<PIN created with a value of '" + pinLogonDTO.PIN1.ToString() + "'>";

                toastService.ShowToast(
                    level: BMdcModel.ToastLevel.Success,
                    message: "<PIN creation succeeded>");

                await pinLogonDialogReference.HideAsync();
            }
            else
            {
                toastService.ShowToast(
                    level: BMdcModel.ToastLevel.Error,
                    message: "PINs do not match");
            }
        }
    }

    async Task CancelClick()
    {
        returnValue = "<CANCELED>";

        await pinLogonDialogReference.HideAsync();
    }

    void FocusPIN(string pin)
    {
        lastFocus = pin;
    }

    void NumberClick(string result)
    {
        if (result == "BKS")
        {
            if (lastFocus.StartsWith("PIN1"))
            {
                if (pinLogonDTO.PIN1.Length > 0)
                {
                    pinLogonDTO.PIN1 = pinLogonDTO.PIN1.Remove(pinLogonDTO.PIN1.Length - 1, 1);
                }
            }
            else
            {
                if (pinLogonDTO.PIN2.Length > 0)
                {
                    pinLogonDTO.PIN2 = pinLogonDTO.PIN2.Remove(pinLogonDTO.PIN2.Length - 1, 1);
                }
            }
        }
        else
        {
            if (lastFocus.StartsWith("PIN1"))
            {
                pinLogonDTO.PIN1 += result;
            }
            else
            {
                pinLogonDTO.PIN2 += result;
            }
        }
    }

}
